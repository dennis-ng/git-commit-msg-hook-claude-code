#!/bin/bash

# Git prepare-commit-msg hook that generates commit messages using Claude Haiku
#
# Installation:
#   1. Copy this file to .git/hooks/prepare-commit-msg
#   2. Make it executable: chmod +x .git/hooks/prepare-commit-msg
#   3. Ensure 'claude' CLI is installed and authenticated

COMMIT_MSG_FILE="$1"
COMMIT_SOURCE="$2"

# Skip if this is a merge, squash, or amend commit
if [ "$COMMIT_SOURCE" = "merge" ] || [ "$COMMIT_SOURCE" = "squash" ] || [ "$COMMIT_SOURCE" = "commit" ]; then
    exit 0
fi

# Skip if a message was provided via -m flag
if [ "$COMMIT_SOURCE" = "message" ]; then
    exit 0
fi

# Check if claude CLI is available
if ! command -v claude &> /dev/null; then
    echo "Warning: 'claude' CLI not found. Skipping auto-commit message generation." >&2
    exit 0
fi

# Get the staged diff
DIFF=$(git diff --cached --diff-algorithm=minimal)

# If no changes staged, exit
if [ -z "$DIFF" ]; then
    exit 0
fi

# Truncate diff if too large (keep under ~10k chars for efficiency)
MAX_DIFF_LENGTH=10000
if [ ${#DIFF} -gt $MAX_DIFF_LENGTH ]; then
    DIFF="${DIFF:0:$MAX_DIFF_LENGTH}

... [diff truncated due to length]"
fi

# Create the prompt
PROMPT="Based on the following git diff, write a concise and descriptive commit message.

Rules:
- First line: short summary (max 50 chars), imperative mood (e.g., \"Add\", \"Fix\", \"Update\")
- If needed, add a blank line followed by bullet points explaining key changes
- Focus on WHAT changed and WHY, not HOW
- Do not include any markdown formatting or code blocks
- Output ONLY the commit message, nothing else

Git diff:
$DIFF"

# Call Claude using the CLI with Haiku model
COMMIT_MSG=$(echo "$PROMPT" | claude -p --model haiku)

# Check if we got a valid response
if [ -z "$COMMIT_MSG" ]; then
    echo "Warning: Failed to generate commit message" >&2
    exit 0
fi

# Write the generated message to the commit message file
echo "$COMMIT_MSG" > "$COMMIT_MSG_FILE"

echo "Generated commit message using Claude Haiku" >&2

# Check for and run local hook if it exists
PROJECT_HOOK=".git/hooks/pre-commit"
if [ -f "$PROJECT_HOOK" ]; then
    echo "Running local pre-commit hook..."
    "$PROJECT_HOOK" "$@"
fi